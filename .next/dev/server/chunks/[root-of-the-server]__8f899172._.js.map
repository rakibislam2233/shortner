{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Rakib/Learning/shortner-v4/app/api/create/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport path from \"path\";\r\nimport fs from \"fs/promises\";\r\n\r\n/**\r\n * Handles POST requests for creating a new shortened URL.\r\n */\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const usernameCookie = req.cookies.get(\"username\");\r\n    const username = usernameCookie?.value;\r\n    if (!username) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const formData = await req.formData();\r\n    const id = formData.get(\"id\");\r\n    const urlMobile = formData.get(\"urlMobile\");\r\n    const urlDesktop = formData.get(\"urlDesktop\");\r\n    const file = formData.get(\"image\");\r\n\r\n    if (\r\n      typeof id !== \"string\" ||\r\n      typeof urlMobile !== \"string\" ||\r\n      !(file instanceof File)\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid form submission\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // ✅ 1) Save uploads OUTSIDE public/\r\n    const uploadsDir = path.join(process.cwd(), \"uploads\");\r\n    await fs.mkdir(uploadsDir, { recursive: true });\r\n\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    const originalName = file.name.replace(/\\s+/g, \"_\");\r\n    const timestamp = Date.now();\r\n    const sanitizedFileName = `${id}-${timestamp}-${originalName}`;\r\n    const filePath = path.join(uploadsDir, sanitizedFileName);\r\n    await fs.writeFile(filePath, buffer);\r\n\r\n    // ✅ 2) Store API path instead of /uploads/…\r\n    const imagePath = `/api/uploads/${sanitizedFileName}`;\r\n\r\n    // ---- links.json handling (unchanged) ----\r\n    const dataDir = path.join(process.cwd(), \"data\");\r\n    await fs.mkdir(dataDir, { recursive: true });\r\n    const dataFile = path.join(dataDir, \"links.json\");\r\n    let linksData: Record<string, any> = {};\r\n    try {\r\n      const json = await fs.readFile(dataFile, \"utf8\");\r\n      linksData = JSON.parse(json);\r\n    } catch {\r\n      linksData = {};\r\n    }\r\n\r\n    const hasFlatEntries = Object.values(linksData).some(\r\n      (v: any) => v && typeof v === \"object\" && \"id\" in v\r\n    );\r\n\r\n    if (hasFlatEntries) {\r\n      if (linksData[id]) {\r\n        return NextResponse.json(\r\n          { error: \"ID already exists\" },\r\n          { status: 400 }\r\n        );\r\n      }\r\n    } else {\r\n      for (const userKey of Object.keys(linksData)) {\r\n        const userEntries = linksData[userKey] ?? {};\r\n        if (userEntries && typeof userEntries === \"object\" && id in userEntries) {\r\n          return NextResponse.json(\r\n            { error: \"ID already exists\" },\r\n            { status: 400 }\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    const newEntry = {\r\n      id,\r\n      image: imagePath, // ✅ using the API URL\r\n      urlMobile,\r\n      urlDesktop: typeof urlDesktop === \"string\" ? urlDesktop : \"\",\r\n    };\r\n\r\n    if (hasFlatEntries) {\r\n      const migrated: Record<string, any> = {};\r\n      migrated[\"global\"] = linksData;\r\n      migrated[username] = { [id]: newEntry };\r\n      linksData = migrated;\r\n    } else {\r\n      const userMap: Record<string, any> = linksData[username] ?? {};\r\n      userMap[id] = newEntry;\r\n      linksData[username] = userMap;\r\n    }\r\n\r\n    await fs.writeFile(dataFile, JSON.stringify(linksData, null, 2));\r\n\r\n    const origin = req.headers.get(\"origin\") ?? \"\";\r\n    const shortUrl = `${origin}/${id}`;\r\n\r\n    return NextResponse.json({ link: shortUrl }, { status: 201 });\r\n  } catch (err) {\r\n    console.error(err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}