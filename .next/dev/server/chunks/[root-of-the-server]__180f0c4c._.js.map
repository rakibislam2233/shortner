{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Rakib/Learning/shortner-v4/app/api/register/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport fs from 'fs/promises';\r\nimport path from 'path';\r\nimport crypto from 'crypto';\r\n\r\n/**\r\n * POST handler for user registration. Accepts a JSON payload with\r\n * `username` and `password`. If the username is available, it\r\n * stores a SHA-256 hash of the password in `data/users.json` and\r\n * logs the user in by setting a cookie. Usernames are not\r\n * case-sensitive and will be normalised to lower case. Passwords\r\n * are not stored in plain text. No email verification or\r\n * sophisticated password hashing is used here as this is a simple\r\n * demonstration.\r\n */\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { username, password } = await req.json();\r\n    if (typeof username !== 'string' || typeof password !== 'string' || !username || !password) {\r\n      return NextResponse.json({ error: 'Invalid request' }, { status: 400 });\r\n    }\r\n    const normalised = username.trim().toLowerCase();\r\n    if (!normalised) {\r\n      return NextResponse.json({ error: 'Invalid username' }, { status: 400 });\r\n    }\r\n    const dataDir = path.join(process.cwd(), 'data');\r\n    await fs.mkdir(dataDir, { recursive: true });\r\n    const usersFile = path.join(dataDir, 'users.json');\r\n    let users: Record<string, string> = {};\r\n    try {\r\n      users = JSON.parse(await fs.readFile(usersFile, 'utf8'));\r\n    } catch {\r\n      users = {};\r\n    }\r\n    if (users[normalised]) {\r\n      return NextResponse.json({ error: 'Username already exists' }, { status: 400 });\r\n    }\r\n    const passwordHash = crypto.createHash('sha256').update(password).digest('hex');\r\n    users[normalised] = passwordHash;\r\n    await fs.writeFile(usersFile, JSON.stringify(users, null, 2));\r\n    // Also ensure the links.json file has a namespace ready for the new user\r\n    const linksFile = path.join(dataDir, 'links.json');\r\n    let linksData: Record<string, any> = {};\r\n    try {\r\n      linksData = JSON.parse(await fs.readFile(linksFile, 'utf8'));\r\n    } catch {\r\n      linksData = {};\r\n    }\r\n    // Determine if file is flat. If so, migrate to nested under 'global'.\r\n    const hasFlatEntries = Object.values(linksData).some(\r\n      (v: any) => v && typeof v === 'object' && 'id' in v\r\n    );\r\n    if (hasFlatEntries) {\r\n      const migrated: Record<string, any> = {};\r\n      migrated['global'] = linksData;\r\n      migrated[normalised] = {};\r\n      linksData = migrated;\r\n    } else {\r\n      if (!linksData[normalised]) {\r\n        linksData[normalised] = {};\r\n      }\r\n    }\r\n    await fs.writeFile(linksFile, JSON.stringify(linksData, null, 2));\r\n    // Set cookie to log the user in after registration\r\n    const res = NextResponse.json({ success: true });\r\n    res.cookies.set('username', normalised, { path: '/' });\r\n    return res;\r\n  } catch (err) {\r\n    console.error('POST /api/register error:', err);\r\n    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAYO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAC7C,IAAI,OAAO,aAAa,YAAY,OAAO,aAAa,YAAY,CAAC,YAAY,CAAC,UAAU;YAC1F,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QACA,MAAM,aAAa,SAAS,IAAI,GAAG,WAAW;QAC9C,IAAI,CAAC,YAAY;YACf,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QACA,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;QACzC,MAAM,gIAAE,CAAC,KAAK,CAAC,SAAS;YAAE,WAAW;QAAK;QAC1C,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,SAAS;QACrC,IAAI,QAAgC,CAAC;QACrC,IAAI;YACF,QAAQ,KAAK,KAAK,CAAC,MAAM,gIAAE,CAAC,QAAQ,CAAC,WAAW;QAClD,EAAE,OAAM;YACN,QAAQ,CAAC;QACX;QACA,IAAI,KAAK,CAAC,WAAW,EAAE;YACrB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QACA,MAAM,eAAe,gHAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,UAAU,MAAM,CAAC;QACzE,KAAK,CAAC,WAAW,GAAG;QACpB,MAAM,gIAAE,CAAC,SAAS,CAAC,WAAW,KAAK,SAAS,CAAC,OAAO,MAAM;QAC1D,yEAAyE;QACzE,MAAM,YAAY,4GAAI,CAAC,IAAI,CAAC,SAAS;QACrC,IAAI,YAAiC,CAAC;QACtC,IAAI;YACF,YAAY,KAAK,KAAK,CAAC,MAAM,gIAAE,CAAC,QAAQ,CAAC,WAAW;QACtD,EAAE,OAAM;YACN,YAAY,CAAC;QACf;QACA,sEAAsE;QACtE,MAAM,iBAAiB,OAAO,MAAM,CAAC,WAAW,IAAI,CAClD,CAAC,IAAW,KAAK,OAAO,MAAM,YAAY,QAAQ;QAEpD,IAAI,gBAAgB;YAClB,MAAM,WAAgC,CAAC;YACvC,QAAQ,CAAC,SAAS,GAAG;YACrB,QAAQ,CAAC,WAAW,GAAG,CAAC;YACxB,YAAY;QACd,OAAO;YACL,IAAI,CAAC,SAAS,CAAC,WAAW,EAAE;gBAC1B,SAAS,CAAC,WAAW,GAAG,CAAC;YAC3B;QACF;QACA,MAAM,gIAAE,CAAC,SAAS,CAAC,WAAW,KAAK,SAAS,CAAC,WAAW,MAAM;QAC9D,mDAAmD;QACnD,MAAM,MAAM,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;QAC9C,IAAI,OAAO,CAAC,GAAG,CAAC,YAAY,YAAY;YAAE,MAAM;QAAI;QACpD,OAAO;IACT,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}